import{E400MissingDefaultExportAsComponent}from"./error.js";import util,{reMDExt,reModuleExt}from"./util.js";const ghostRoute={path:"",module:{id:"",hash:""}};export class Routing{constructor(t=[],e="/",s="en",n=[]){this._routes=t;this._baseUrl=e;this._defaultLocale=s;this._locales=n}get baseUrl(){return this._baseUrl}get paths(){const t=[];this._lookup(e=>{t.push(e.map(t=>t.path).join(""))},true);return t}get routes(){return JSON.parse(JSON.stringify(this._routes))}update(t){const e={path:getPagePath(t.id),module:t};const s=new Set;let n=false;let o=this._routes;this._lookup(i=>{const a=i.map(t=>t.path).join("");const l=i[i.length-1];const r=i[i.length-2];if(l.module.id===t.id){Object.assign(l.module,t);n=true;return false}if(!e.path.endsWith("/")&&a.startsWith(e.path+"/")){const t=r?r.children:this._routes;const n=t.indexOf(l);if(n>=0){t.splice(n,1,ghostRoute);s.add(t)}(e.children||(e.children=[])).push(Object.assign(Object.assign({},l),{path:util.trimPrefix(a,e.path)}))}else if(!a.endsWith("/")&&e.path.startsWith(a+"/")){e.path=util.trimPrefix(e.path,a);o=l.children||(l.children=[])}});if(n){return}s.forEach(t=>{let e;while(~(e=t.indexOf(ghostRoute))){t.splice(e,1)}});s.clear();o.push(e)}removeRoute(t){this._lookup(e=>{const s=e[e.length-1];if(s.module.id===t){const t=e[e.length-2];const n=t?t.children:this._routes;const o=n.indexOf(s);if(o>=0){n.splice(o,1,...(s.children||[]).map(t=>Object.assign(Object.assign({},t),{path:s.path+t.path})))}return false}})}createRouter(t){const e=t||window.location||{pathname:"/"};const s=new URLSearchParams(e.search);let n=this._defaultLocale;let o=util.cleanPath(util.trimPrefix(e.pathname,this._baseUrl));let i="";let a={};let l=[];if(o!=="/"&&this._locales.length>0){const t=o.split("/");const e=t[1];if(e!==n&&this._locales.includes(e)){n=e;o="/"+t.slice(2).join("/")}}this._lookup(t=>{var e;const s=t.map(t=>t.path).join("");const[n,r]=matchPath(s,o);if(r){l=t.map(t=>t.module);const o=(e=t[t.length-1].children)===null||e===void 0?void 0:e.find(t=>t.path==="/");if(o){l.push(o.module)}i=s;a=n;return false}},true);return[{locale:n,pathname:o,pagePath:i,params:a,query:s},l]}lookup(t){this._lookup(t)}_lookup(t,e=false,s=[],n=this._routes){var o;for(const o of n){if(e&&s.length>0&&o.path==="/"){continue}if(t([...s,o])===false){return false}}for(const i of n){if(i.path!=="/"&&((o=i.children)===null||o===void 0?void 0:o.length)){if(this._lookup(t,e,[...s,i],i.children)===false){return false}}}}}export function getPagePath(t){const e=util.trimSuffix(t,".js").replace(reMDExt,"").toLowerCase().replace(/^\/pages\//,"/").replace(/\/?index$/,"/");return e.startsWith("/api/")?e:e.replace(/\s+/g,"-")}function matchPath(t,e){const s={};const n=util.splitPath(t);const o=util.splitPath(e);const i=Math.max(n.length,o.length);for(let t=0;t<i;t++){const e=n[t];const i=o[t];if(i===undefined||e===undefined){return[{},false]}if(e.startsWith("[...")&&e.endsWith("]")&&e.length>5&&t===n.length-1){s[e.slice(4,-1)]=o.slice(t).map(decodeURIComponent).join("/");break}if(e.startsWith("[")&&e.endsWith("]")&&e.length>2){s[e.slice(1,-1)]=decodeURIComponent(i)}else if(e.startsWith("$")&&e.length>1){s[e.slice(1)]=decodeURIComponent(i)}else if(e!==i){return[{},false]}}return[s,true]}export function createPageProps(t){const e={Page:null,pageProps:{}};if(t.length>0){Object.assign(e,_createPagePropsSegment(t[0]))}if(t.length>1){t.slice(1).reduce((t,e)=>{const s=_createPagePropsSegment(e);t.pageProps=s;return s},e)}return e}function _createPagePropsSegment(t){const e={Page:null,pageProps:{}};if(t.Component){if(util.isLikelyReactComponent(t.Component)){e.Page=t.Component}else{e.Page=E400MissingDefaultExportAsComponent;e.pageProps={name:"Page:"+t.id.replace(reModuleExt,"")}}}return e}